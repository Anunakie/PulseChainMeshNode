name: Build PulseMesh Node

on:
  push:
    branches: [main]
    paths:
      - 'node/**'
      - 'pulsemesh/**'
      - 'pulsemesh_lib/**'
      - 'automap/**'
      - 'dns_utility/**'
      - 'ip_country/**'
      - '.github/workflows/build-node.yml'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust 1.63
        uses: actions-rs/toolchain@v1
        with:
          toolchain: '1.63.0'
          override: true

      - name: Install libsodium via vcpkg
        shell: powershell
        run: |
          vcpkg install libsodium:x64-windows-static
          $vcpkgRoot = "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows-static"
          echo "SODIUM_LIB_DIR=$vcpkgRoot/lib" >> $env:GITHUB_ENV
          echo "SODIUM_SHARED=0" >> $env:GITHUB_ENV
          echo "SODIUM_INCLUDE_DIR=$vcpkgRoot/include" >> $env:GITHUB_ENV
          echo "Sodium lib dir: $vcpkgRoot/lib"
          Get-ChildItem "$vcpkgRoot/lib" -Filter *sodium*

      - name: Build node (release)
        working-directory: node
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
        run: cargo build --release --bin PulseMeshNodeW

      - name: Build CLI tools
        continue-on-error: true
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
        run: |
          cd pulsemesh; cargo build --release --bin pulsemesh; cd ..
          cd dns_utility; cargo build --release --bin dns_utilityw; cd ..

      - name: Package Windows binaries
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist/PulseMeshNode-Windows
          Copy-Item node/target/release/PulseMeshNodeW.exe dist/PulseMeshNode-Windows/PulseMeshNode.exe -ErrorAction SilentlyContinue
          Copy-Item pulsemesh/target/release/pulsemesh.exe dist/PulseMeshNode-Windows/ -ErrorAction SilentlyContinue
          Copy-Item dns_utility/target/release/dns_utilityw.exe dist/PulseMeshNode-Windows/dns_utility.exe -ErrorAction SilentlyContinue
          Copy-Item node/target/release/pulsemesh.exe dist/PulseMeshNode-Windows/ -ErrorAction SilentlyContinue
          Copy-Item node/target/release/dns_utilityw.exe dist/PulseMeshNode-Windows/dns_utility.exe -ErrorAction SilentlyContinue
          Set-Content dist/PulseMeshNode-Windows/README.txt "PulseMesh Node - Windows`r`n========================`r`n1. Run: PulseMeshNode.exe --help`r`n2. Start node: PulseMeshNode.exe --neighborhood-mode standard --blockchain-service-url https://rpc.pulsechain.com --chain mainnet"
          Compress-Archive -Path dist/PulseMeshNode-Windows -DestinationPath dist/PulseMeshNode-Windows.zip

      - uses: actions/upload-artifact@v4
        with:
          name: PulseMeshNode-Windows
          path: dist/PulseMeshNode-Windows.zip
